<!DOCTYPE html>
<html>

<head>
<title>Trading Experiment</title>
<style>
html, body, p {
  padding: 0;
  margin: 0;
  font-family: verdana;
}
#header {
  width: 100%;
  background-color: black;
  color: white;
  height: 6em;
}
.hleft {
  font-size: 4em;
  position: absolute;
  margin-left: 10px;
}
.hright {
  float: right;
  margin-top: 4em;
  margin-right: 10px;
}
#start, #read, #qs, #play, #trade {
  background-color: black;
  color: white;
  font-size: 1em;
}
#main {
  margin-top: 1em;
  margin-left: 5%;
  margin-right: 5%;
}
#code, #apples {
  width: 40px;
  font-size: 1em;
}
</style>
</head>

<body>
<div id="header">
<p class="hleft">Trading Experiment</p>
<p class="hright">Thank you for participating</p>
</div>
<br>
<div id="main">
Please enter your 4-digit code: <input id="code"><button id="start">Enter</button>
<br>Randomly assigned codes for class testing:<br>
  Patrick: 1000<br>
  Lauren, Sam: 2000<br>
  Hannah V: 3000<br>
  Crozier, English: 4000<br>
  Logan: 5000
<p id="error" style="color: red"></p>
</div>
<p id="timer" style="display:none"></p>
<br>
<script>
var outCode = "";
var codes = [1700, 1000, 2000, 3000, 4000, 5000];
var treatment = 0;
var code = 0;
function enter() {
  code = document.getElementById("code").value;
  treatment = parseInt(code[0]);
  outCode = code[0];
  if (codes.indexOf(parseInt(code)) == -1) {
    document.getElementById("error").innerHTML = "Please enter a valid code";
  } else {
    document.getElementById("main").innerHTML = `<p>Please review the following information regarding this study:<br>
<br>
No identifying information about you is collected here. If you so choose, you do not have to share any personal information. You can terminate your involvement with the study at any time, without giving a reason.<br>
<br>
</p>
<button id="read">Continue</button><br>
<p id="error" style="color: red"></p>`;
  document.getElementById("read").onclick = questions;
  }
}
document.getElementById("start").onclick = enter;

function questions() {
  document.getElementById("main").innerHTML = `<p>Please complete the following questionnaire. Remember, you are not obligated to answer. If you do not want to answer any questions, simply select "Prefer not to say."<br>
<br>
1. Select your school class:<br>
<input type="radio" name="class" id="c9" value="1"><label for="c9">Freshman</label><br>
<input type="radio" name="class" id="c10" value="2"><label for="c10">Sophomore</label><br>
<input type="radio" name="class" id="c11" value="3"><label for="c11">Junior</label><br>
<input type="radio" name="class" id="c12" value="4"><label for="c12">Senior</label><br>
<input type="radio" name="class" id="cnan" value="5"><label for="cnan">Prefer not to say</label><br>
<br>
2. Indicate your gender:<br>
<input type="radio" name="gender" id="gm" value="1"><label for="gm">Male</label><br>
<input type="radio" name="gender" id="gf" value="2"><label for="gf">Female</label><br>
<input type="radio" name="gender" id="go" value="3"><label for="go">Other</label> (Specify, if desired: <input id="gos">)<br>
<input type="radio" name="gender" id="gnan" value="4"><label for="gnan">Prefer not to say</label><br>
<br>
3. How many Honors, AP, and Dual Enrollment classes are you in?<br>
<input type="radio" name="hap" id="h0" value="1"><label for="h0">0</label><br>
<input type="radio" name="hap" id="h1" value="2"><label for="h1">1</label><br>
<input type="radio" name="hap" id="h2" value="3"><label for="h2">2</label><br>
<input type="radio" name="hap" id="h3" value="4"><label for="h3">3</label><br>
<input type="radio" name="hap" id="h4" value="5"><label for="h4">4</label><br>
<input type="radio" name="hap" id="h5" value="6"><label for="h5">5</label><br>
<input type="radio" name="hap" id="h6" value="7"><label for="h6">6</label><br>
<input type="radio" name="hap" id="hnan" value="8"><label for="hnan">Prefer not to say</label><br>
<br>
4. What letter grade range do you tend to get (do NOT bump it up for AP classes)?<br>
<input type="radio" name="grade" id="gpa" value="1"><label for="gpa">A</label><br>
<input type="radio" name="grade" id="gpb" value="2"><label for="gpb">B</label><br>
<input type="radio" name="grade" id="gpc" value="3"><label for="gpc">C</label><br>
<input type="radio" name="grade" id="gpd" value="4"><label for="gpd">D</label><br>
<input type="radio" name="grade" id="gpf" value="5"><label for="gpf">F</label><br>
<input type="radio" name="grade" id="gpnan" value="6"><label for="gpnan">Prefer not to say</label><br>
<br>
<button id="qs">Submit</button>
</p>
<br>
<p id="error" style="color: red"></p><br>`;
  document.getElementById("qs").onclick = intro;
}

function intro() {
  var ids = ["c9", "c10", "c11", "c12", "cnan", "gm", "gf", "go", "gnan", "h0", "h1", "h2", "h3", "h4", "h5", "h6", "hnan", "gpa", "gpb", "gpc", "gpd", "gpf", "gpnan"];
  var checked = 0;
  var qas = "";
  for(var i = 0; i < 23; i++) {
    if(document.getElementById(ids[i]).checked) {
      checked++
      qas = qas + document.getElementById(ids[i]).value;
      if(ids[i] == "go") {qas = qas + document.getElementById("gos").value;}
    }
  }
  if(checked < 4) {
    document.getElementById("error").innerHTML = 'Please select an answer to every question. If you do not wish to answer a question, please select "Prefer not to say."';
  } else {
    outCode = outCode + qas;
    document.getElementById("main").innerHTML = `<p>You will be playing a trading game with your partner. The two of you are playing simultaneously. Each round, you will decide how many apples to give to your partner, and they will decide how many oranges to give to you. Every round you will be requesting 20 oranges, and your partner will be requesting 20 apples. You can decide to give anywhere from 0 to 20 apples, and they can decide to give anywhere from 0 to 20 oranges. At the end of each round, you will be told how much they gave and they will be told how much you gave.<br>
<br>
<button id="play" onclick>Start</button><br>
<p id="error" style="color: red"></p>`;
    document.getElementById("play").onclick = gameRound;
  }
}

var round = 0;
var give = [];
var times = [];
var given = 0;
var gave = 0;
var time = 0;
var round = 0;
function is020(n) {
  n = String(n);
  var out = true;
  var digits = ["0","1","2","3","4","5","6","7","8","9"];
  for(var i = 0; i < n.length; i++) { if( digits.indexOf(n[i]) == -1 ) { out = false; } }
  if( n == "") { out = false }
  n = parseInt(n);
  if( n < 0 || n > 20) { out = false }
  return out;
}

function gameRound() {
  if(round == 0) {var incrementTime = setInterval(function () {time++; document.getElementById("timer").innerHTML = time;}, 1000);}
  if(round > 0) {gave = document.getElementById("apples").value;}
  if(is020(gave)) {
    gave = parseInt(gave);
    round++
    if(round > 1) {
      var get = [20, Math.min(20, Math.ceil(1.25*give[round-3])), give[round-3], Math.floor(0.75*give[round-3]), 0];
      given = (round > 2 ? get[treatment - 1] : [20,20,20,15,0][treatment - 1]);
      give.push(gave);
      times.push(time);
    }
    var partnerTime = Math.floor(Math.random() * 10) + 3;
    if(time < partnerTime) {
      document.getElementById("main").innerHTML = "<h2>Waiting for partner...</h2>";
      setTimeout(function () { document.getElementById("main").innerHTML = ""; setTimeout(game(), 1000); }, 1000 * (partnerTime - time) );
    } else {
      document.getElementById("main").innerHTML = "";
      setTimeout(game(), 1000);
    }
  } else { document.getElementById("error").innerHTML = "Please enter a whole number 0-20." }
}

function game() {
  time = 0;
  if (round < 11) {
    document.getElementById("main").innerHTML = `<p>` + (round > 1 ? `You gave your partner ` + (gave > 0 ? gave : "no") + ` apple` + (gave == 1 ? "" : "s") + ` out of the 20 they requested. <br> Your partner gave you ` + (given > 0 ? given : "no") + ` orange` + (given == 1 ? "" : "s") + ` out of the 20 you requested. <br><br> ` : ``) + `Your partner is requesting 20 apples. You are requesting 20 oranges.<br>
<br>
How many apples do you want to give to your partner?<br><br>
<input id="apples"><button id="trade" onclick="gameRound()">Give</button>
<br><p id="error" style="color: red"></p><br>`;
    document.getElementById("trade").addEventListener("keyup", function (event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        document.getElementById("trade").click();
      }
    });
  } else {
    var table = "<table>\n<tbody>\n<tr>\n<th>Round</th><th>Gave</th><th>Time</th>\n</tr>";
    for(var i = 0; i < 10; i++) {
      table = table + "<tr>\n<td>" + String(i + 1) + "</td><td>" + give[i] + "</td><td>" + times[i] + "</td>\n</tr>\n"
    }
    table = table + "</tbody>\n</table>";
    for(var i = 0; i < 10; i++) {
      outCode = outCode + (give[i] > 9 ? "" : "0") + give[i];
    }
    for(var i = 0; i < 10; i++) {
      outCode = outCode + (times[i] > 99 ? "" : "0") + (times[i] > 9 ? "" : "0") + times[i];
    }
    //document.getElementById("main").innerHTML = table + "<br>" + outCode + '<br><p id="error" style="color: red"></p>';
    var link = "https://docs.google.com/forms/d/e/1FAIpQLSdyVEthUrj-fy0MHDCvUTmEhQ9nKiQ43Sb7w1zyWjpHVe1HyA/formResponse?&entry.990966079=" + outCode + "&submit=SUBMIT";
    document.getElementById("main").innerHTML = `<div style="display: none">\n` + table + `\n` + outCode + `\n` + `<iframe src="` + link + `"></iframe><br></div>
<p>The experiment is now complete. Thank you for your participation. You will be emailed after data collection is finished (most likely in about a week) debriefing you on the experiment.</p>`;
  }
}


</script>
</body>

</html>
